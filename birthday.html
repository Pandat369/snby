<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Website rainlove - n∆°i chia s·∫ª t√¨nh y√™u th∆∞∆°ng." />
    <title>Textlove</title>
    <link rel="icon" href="https://github.com/Panbap/anh/blob/main/icon1.png?raw=true" type="image/png" />
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans:wght@100..800&display=swap" rel="stylesheet">
    <style>
        html,
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden;
            background: #000;
            height: 100vh;
            width: 100vw;
            position: relative;
            color: white;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        #sticker {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            height: 450px;
            z-index: 10;
            pointer-events: none;
        }

        #nextPageBtn {
            position: fixed;
            top: calc(50% + 240px);
            /* th·∫•p h∆°n ·∫£nh sticker (450px / 2 = 225 + ch√∫t kho·∫£ng c√°ch) */
            left: 50%;
            transform: translateX(-50%);
            z-index: 11;
            padding: 8px 15px;
            font-size: 1.2rem;
            background-color: #f584b7;
            border: none;
            border-radius: 8px;
            font-family: "Playpen Sans", cursive;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(245, 132, 183, 0.6);
            transition: background-color 0.3s ease;
        }

        #nextPageBtn:hover {
            background-color: #e0538d;
        }

        audio {
            display: none;
        }

        #rotateWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgb(199, 199, 199);
            color: rgb(0, 0, 0);
            font-size: 1.2rem;
            text-align: center;
            font-family: "Playpen Sans", cursive;
            padding-top: 40vh;
            z-index: 20;
        }

        #rotateIcon {
            width: 120px;
            height: auto;
            margin-bottom: 20px;
            animation: rotatePhone 2s infinite ease-in-out;
            transform-origin: center;
        }

        @keyframes rotatePhone {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(20deg);
            }

            50% {
                transform: rotate(0deg);
            }

            75% {
                transform: rotate(-20deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @media (max-width: 768px) {
            #sticker {
                width: 150px;
                height: 150px;
            }

            #nextPageBtn {
                top: calc(50% + 100px);
                padding: 10px 15px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <canvas id="rainCanvas"></canvas>
    <canvas id="canvas"></canvas>
    <img id="sticker" src="" alt="Sticker" />
    <button id="nextPageBtn" style="display:none;">Qu√† n√®</button>
    <audio id="bgm" loop></audio>

    <div id="rotateWarning">
        <img id="rotateIcon" src="./img/123.png" alt="Rotate phone" />
        <br />
        Vui l√≤ng xoay ngang m√†n h√¨nh!
    </div>

    <script>
        // Rain effect on rainCanvas
        const canva = document.getElementById('rainCanvas');
        const ctxs = canva.getContext('2d');

        const letters = 'Happy Birthday'.split('');
        const fontSize = 16;
        let columns = Math.floor(window.innerWidth / fontSize);
        const drops = Array(columns).fill(1);

        function resizeRainCanvas() {
            canva.width = window.innerWidth;
            canva.height = window.innerHeight;
            columns = Math.floor(canva.width / fontSize);
            drops.length = columns;
            drops.fill(1);
        }

        resizeRainCanvas();
        window.addEventListener('resize', resizeRainCanvas);

        function drawRainBackground() {
            ctxs.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctxs.fillRect(0, 0, canva.width, canva.height);
            ctxs.fillStyle = 'rgb(195, 130, 255)';
            ctxs.font = fontSize + 'px Playpen Sans';
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctxs.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canva.height || Math.random() > 0.95) drops[i] = 0;
                drops[i]++;
            }
        }

        setInterval(drawRainBackground, 50);

        const nextPageBtn = document.getElementById('nextPageBtn');

        function showStickerAndButton() {
            if (
                sticker.src &&
                sticker.src !== window.location.href &&
                sticker.src.trim() !== ''
            ) {
                sticker.style.display = 'block';
                nextPageBtn.style.display = 'block';
            }
        }

        function hideStickerAndButton() {
            sticker.style.display = 'none';
            nextPageBtn.style.display = 'none';
        }

        function morphToNextText() {
            currentIndex++;
            if (currentIndex >= texts.length) {
                particles = [];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvas.style.display = 'none';
                showStickerAndButton();
                stopAnimation = true;
                return;
            }

            const nextDots = generateDots(texts[currentIndex]);
            interpolateParticles(nextDots);
            lastMorphTime = Date.now();
        }

        function stopAnimationFunc() {
            rotateWarning.style.display = 'block';
            mainCanvas.style.display = 'none';
            mainSticker.style.display = 'none';

            if (window.innerWidth <= 768 && window.innerHeight > window.innerWidth) {
                nextPageBtn.style.display = 'block';
            } else {
                nextPageBtn.style.display = 'none';
            }

            stopAnimation = true;
            animationRunning = false;
        }

        nextPageBtn.addEventListener('click', () => {
            window.location.href = './galaxy.html';
        });

        // Particle text effect on canvas
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const isMobile = window.innerWidth < 768;
        const gap = isMobile ? 3 : 5;

        const shapeCanvas = document.createElement('canvas');
        shapeCanvas.width = canvas.width = window.innerWidth;
        shapeCanvas.height = canvas.height = window.innerHeight;
        const shapeCtx = shapeCanvas.getContext('2d');

        let inputText = 'Ch√∫c m·ª´ng|sinh nh·∫≠t|b·∫°n y√™u|üéÇ';
        let gif = './img/a2.jpg';

        const sticker = document.getElementById('sticker');
        if (gif && gif.trim() !== '') {
            sticker.src = decodeURIComponent(gif);
        }

        const bgm = document.getElementById('bgm');
        const music = './img/Ly.mp3';

        if (music && music.trim() !== '') {
            bgm.src = decodeURIComponent(music);

            bgm.play().catch(() => {
                console.warn('Ch·ªù ng∆∞·ªùi d√πng click ƒë·ªÉ ph√°t nh·∫°c.');
            });

            document.addEventListener('click', () => {
                if (bgm.paused) {
                    bgm.play().catch(() => {
                        console.warn('Kh√¥ng th·ªÉ ph√°t nh·∫°c do tr√¨nh duy·ªát.');
                    });
                }
            });
        }

        const texts = inputText.split('|').filter((line) => line.trim() !== '');
        let currentIndex = 0;
        let particles = [];
        let morphDelay = 600;
        let lastMorphTime = Date.now();
        let stopAnimation = false;

        function getFittedFont(text) {
            let fontSize = 200;
            shapeCtx.font = `bold ${fontSize}px Segoe UI`;
            let textWidth = shapeCtx.measureText(text.replace('\n', '')).width;
            while (
                (textWidth > shapeCanvas.width * 0.9 || fontSize > shapeCanvas.height * 0.8) &&
                fontSize > 10
            ) {
                fontSize -= 5;
                shapeCtx.font = `bold ${fontSize}px Segoe UI`;
                textWidth = shapeCtx.measureText(text.replace('\n', '')).width;
            }

            if (window.innerWidth < 400) {
                fontSize = Math.min(fontSize, 80);
            }

            return fontSize;
        }

        function generateDots(text) {
            shapeCtx.clearRect(0, 0, shapeCanvas.width, shapeCanvas.height);
            const lines = text.split('\n');
            const fontSize = getFittedFont(text);
            shapeCtx.font = `bold ${fontSize}px Segoe UI`;
            shapeCtx.fillStyle = '#fff';
            shapeCtx.textAlign = 'center';
            shapeCtx.textBaseline = 'middle';

            const lineHeight = fontSize * 1.2;
            const totalHeight = lineHeight * lines.length;
            const startY = shapeCanvas.height / 2 - totalHeight / 2 + lineHeight / 2;

            for (let i = 0; i < lines.length; i++) {
                shapeCtx.fillText(lines[i], shapeCanvas.width / 2, startY + i * lineHeight);
            }

            const imageData = shapeCtx.getImageData(0, 0, shapeCanvas.width, shapeCanvas.height).data;
            const dots = [];
            for (let y = 0; y < shapeCanvas.height; y += gap) {
                for (let x = 0; x < shapeCanvas.width; x += gap) {
                    const i = (y * shapeCanvas.width + x) * 4;
                    if (imageData[i + 3] > 128) {
                        dots.push({ x, y });
                    }
                }
            }
            return dots;
        }

        function interpolateParticles(toDots) {
            const max = Math.max(particles.length, toDots.length);
            const newParticles = [];
            for (let i = 0; i < max; i++) {
                const from = particles[i % particles.length] || {
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                };
                const to = toDots[i % toDots.length];

                newParticles.push({
                    x: from.x,
                    y: from.y,
                    tx: to.x,
                    ty: to.y,
                    progress: 0,
                    speed: 0.03 + Math.random() * 0.02,
                });
            }
            particles = newParticles;
        }

        function updateParticles() {
            for (let p of particles) {
                if (p.progress < 1) {
                    p.progress += p.speed;
                    if (p.progress > 1) p.progress = 1;
                }
                p.x += (p.tx - p.x) * p.speed;
                p.y += (p.ty - p.y) * p.speed;
            }
        }

        function drawParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let p of particles) {
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(p.x, p.y, isMobile ? 1.3 : 2.3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function morphToNextText() {
            currentIndex++;
            if (currentIndex >= texts.length) {
                particles = [];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvas.style.display = 'none';
                showStickerAndButton();
                stopAnimation = true;
                return;
            }

            const nextDots = generateDots(texts[currentIndex]);
            interpolateParticles(nextDots);
            lastMorphTime = Date.now();
        }

        function animate() {
            if (stopAnimation) return;
            updateParticles();
            drawParticles();
            const allArrived = particles.every(
                (p) => Math.abs(p.x - p.tx) < 0.5 && Math.abs(p.y - p.ty) < 0.5
            );
            if (allArrived && Date.now() - lastMorphTime > morphDelay) {
                morphToNextText();
            }
            requestAnimationFrame(animate);
        }

        const firstDots = generateDots(texts[0]);
        particles = firstDots.map((p) => ({
            x: canvas.width / 2,
            y: canvas.height / 2,
            tx: p.x,
            ty: p.y,
            progress: 0,
            speed: 0.05 + Math.random() * 0.05,
        }));

        canvas.style.display = 'none';
        setTimeout(() => {
            canvas.style.display = 'block';
            lastMorphTime = Date.now();
            animate();
        }, 1000);

        function isLandscape() {
            return window.innerWidth > window.innerHeight;
        }

        const rotateWarning = document.getElementById('rotateWarning');
        const mainCanvas = canvas;
        const mainSticker = sticker;

        let animationRunning = false;

        function startAnimation() {
            rotateWarning.style.display = 'none';

            if (stopAnimation && currentIndex >= texts.length) {
                canvas.style.display = 'none';
                sticker.style.display = 'block';
                nextPageBtn.style.display = 'block';
                return;
            }

            mainCanvas.style.display = 'block';
            mainSticker.style.display = 'none';
            stopAnimation = false;
            lastMorphTime = Date.now();

            if (!animationRunning) {
                animationRunning = true;
                animate();
            }
        }


        function stopAnimationFunc() {
            rotateWarning.style.display = 'block';
            mainCanvas.style.display = 'none';

            if (sticker.style.display !== 'block') {
                mainSticker.style.display = 'none';
            }

            stopAnimation = true;
            animationRunning = false;
        }

        function checkOrientationAndStart() {
            if (isLandscape()) {
                startAnimation();
            } else {
                stopAnimationFunc();
            }
        }

        function onResizeOrOrientationChange() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            shapeCanvas.width = canvas.width;
            shapeCanvas.height = canvas.height;
            resizeRainCanvas();

            if (texts[currentIndex]) {
                const dots = generateDots(texts[currentIndex]);
                particles = dots.map((p) => ({
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    tx: p.x,
                    ty: p.y,
                    progress: 0,
                    speed: 0.05 + Math.random() * 0.05,
                }));
            }

            checkOrientationAndStart();
        }

        window.addEventListener('resize', onResizeOrOrientationChange);
        window.addEventListener('orientationchange', onResizeOrOrientationChange);

        checkOrientationAndStart();

        window.addEventListener("load", function() {
    // ƒê·ª£i ch√∫t r·ªìi cu·ªôn l√™n ƒë·ªÉ thanh ƒë·ªãa ch·ªâ bi·∫øn m·∫•t
    setTimeout(function() {
        window.scrollTo(0, 1);
    }, 100);
});

    </script>
</body>

</html>
